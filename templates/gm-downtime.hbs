<div class="po-window po-window-rest" data-tool="gm-downtime" role="region" aria-label="Party Operations GM Downtime">
  <header class="po-header">
    <div class="po-header-main">
      <h1 class="po-title">Party Operations <span class="po-pill">v{{moduleVersion}}</span></h1>
      <div class="po-subtitle" aria-live="polite">GM Downtime - Generated {{generatedAtLabel}} by {{generatedBy}}</div>
    </div>
    <div class="po-controls">
      <button type="button" class="po-btn po-btn-sm" data-action="gm-downtime-page-back">Back</button>
      <button type="button" class="po-icon-btn" data-action="gm-downtime-page-refresh" aria-label="Refresh">
        <i class="fa-solid fa-rotate"></i>
      </button>
    </div>
  </header>

  <div class="po-body">
    <section class="po-content" id="po-panel-gm-downtime-page">
      <div id="po-gm-downtime" class="po-gm-section po-downtime-panel">
        <div class="po-section-title">GM Downtime Controls</div>
        <div class="po-hint">Tune downtime, add manual entries, resolve pending submissions, and edit completed outcomes.</div>

        <div class="po-info-strip">
          <div class="po-info-chip"><span>Hours Granted</span><strong>{{downtime.hoursGranted}}</strong></div>
          <div class="po-info-chip"><span>Pending</span><strong>{{downtime.pendingCount}}</strong></div>
          <div class="po-info-chip"><span>Resolved</span><strong>{{downtime.resolvedCount}}</strong></div>
          <div class="po-info-chip"><span>Recent Logs</span><strong>{{downtime.logCount}}</strong></div>
        </div>

        <div class="po-two-col">
          <div class="po-col">
            <div class="po-op-role-row">
              <div class="po-op-role-head">
                <div class="po-op-role-name">Downtime Tuning</div>
                <div class="po-op-role-status">GM</div>
              </div>
              <label class="po-resource-row">
                <span>Granted Hours</span>
                <input type="number" min="1" max="24" step="1" class="po-input" value="{{downtime.hoursGranted}}" data-action="set-downtime-hours" />
              </label>
              <label class="po-resource-row">
                <span>Economy</span>
                <select class="po-select" data-action="set-downtime-tuning" data-tuning="economy">
                  {{#each downtime.tuning.economyOptions}}
                  <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row">
                <span>Complication Risk</span>
                <select class="po-select" data-action="set-downtime-tuning" data-tuning="risk">
                  {{#each downtime.tuning.riskOptions}}
                  <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row">
                <span>Discovery Density</span>
                <select class="po-select" data-action="set-downtime-tuning" data-tuning="discovery">
                  {{#each downtime.tuning.discoveryOptions}}
                  <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>
            </div>

            <div class="po-op-role-row">
              <div class="po-op-role-head">
                <div class="po-op-role-name">Submit Downtime Action</div>
                <div class="po-op-role-status">Manual</div>
              </div>
              <label class="po-resource-row">
                <span>Actor</span>
                <select name="downtimeActorId" class="po-select">
                  {{#each downtime.submit.actorOptions}}
                  <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row">
                <span>Action</span>
                <select name="downtimeActionKey" class="po-select">
                  {{#each downtime.submit.actionOptions}}
                  <option value="{{key}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row">
                <span>Hours</span>
                <input name="downtimeHours" type="number" min="1" max="{{downtime.hoursGranted}}" step="1" class="po-input" value="{{downtime.submit.hours}}" />
              </label>
              <label class="po-resource-row po-notes-row-lg">
                <span>Note</span>
                <textarea name="downtimeNote" rows="3" class="po-input" placeholder="Optional intent, location, contact, or item target">{{downtime.submit.note}}</textarea>
              </label>
              <button type="button" class="po-btn" data-action="submit-downtime-action">Submit Downtime Action</button>
            </div>

            <div class="po-op-role-row po-downtime-resolver">
              <div class="po-op-role-head">
                <div class="po-op-role-name">Pending Resolver</div>
                <div class="po-op-role-status">{{downtime.pendingCount}} pending</div>
              </div>
              {{#if downtime.gmResolve.hasPending}}
              <label class="po-resource-row">
                <span>Pending Entry</span>
                <select name="resolveDowntimeActorId" class="po-select" data-action="set-downtime-resolve-target">
                  {{#each downtime.gmResolve.pendingOptions}}
                  <option
                    value="{{actorId}}"
                    {{#if selected}}selected{{/if}}
                    data-action-key="{{actionKey}}"
                    data-base-summary="{{baseSummary}}"
                    data-base-gp="{{baseGpAward}}"
                    data-base-cost="{{baseGpCost}}"
                    data-base-rumors="{{baseRumorCount}}"
                    data-base-items="{{baseItemRewardsText}}"
                    data-base-item-drops="{{baseItemRewardDropsJson}}"
                    data-base-notes="{{baseNotes}}"
                    data-base-contract-key="{{baseSocialContractKey}}"
                    data-base-contract-notes="{{baseSocialContractNotes}}"
                    data-base-hint="{{baseHint}}"
                  >{{label}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row">
                <span>Outcome Summary</span>
                <input type="text" name="resolveDowntimeSummary" class="po-input" value="{{downtime.gmResolve.summary}}" placeholder="Short player-facing result summary" />
              </label>
              <label class="po-resource-row">
                <span>Money Award (gp)</span>
                <input type="number" min="0" step="1" name="resolveDowntimeGp" class="po-input" value="{{downtime.gmResolve.gpAward}}" />
              </label>
              <label class="po-resource-row">
                <span>Cost to Collect (gp)</span>
                <input type="number" min="0" step="1" name="resolveDowntimeCost" class="po-input" value="{{downtime.gmResolve.gpCost}}" />
              </label>
              <label class="po-resource-row">
                <span>Rumor / Lead Count</span>
                <input type="number" min="0" step="1" name="resolveDowntimeRumors" class="po-input" value="{{downtime.gmResolve.rumorCount}}" />
              </label>
              <label class="po-resource-row">
                <span>Social Contract Type</span>
                <select name="resolveDowntimeContractKey" class="po-select">
                  {{#each downtime.gmResolve.socialContractOptions}}
                  <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>
              <label class="po-resource-row po-notes-row-lg">
                <span>Social Contract Notes</span>
                <textarea name="resolveDowntimeContractNotes" rows="2" class="po-input" placeholder="City, broker details, and usage limits">{{downtime.gmResolve.socialContractNotes}}</textarea>
              </label>
              <label class="po-resource-row po-notes-row-lg">
                <span>Item Rewards (one per line)</span>
                <div class="po-loot-preview-dropzone" data-downtime-item-dropzone>Drag an Item here to add a reward line.</div>
                <textarea name="resolveDowntimeItems" rows="3" class="po-input" data-downtime-item-dropzone placeholder="e.g., Potion of Healing">{{downtime.gmResolve.itemRewardsText}}</textarea>
              </label>
              <label class="po-resource-row po-notes-row-lg">
                <span>Crafting Item Grants (Inventory on Collect)</span>
                <input type="hidden" name="resolveDowntimeItemDrops" value="{{downtime.gmResolve.itemRewardDropsJson}}" />
                <div class="po-loot-preview-dropzone" data-downtime-crafting-item-dropzone>Drag dropped items here when resolving a Crafting entry.</div>
                <div class="po-loot-preview-items-grid" data-downtime-item-drop-list data-downtime-crafting-item-dropzone>
                  {{#if downtime.gmResolve.hasItemRewardDrops}}
                  {{#each downtime.gmResolve.itemRewardDrops}}
                  <div class="po-op-role-row">
                    <div class="po-op-role-head">
                      <div class="po-op-role-name"><img src="{{img}}" width="18" height="18" /> {{name}}</div>
                      <div class="po-op-role-status">x{{quantity}}</div>
                    </div>
                    <div class="po-op-summary">{{#if uuid}}{{uuid}}{{else}}World Item / Snapshot{{/if}}</div>
                    <div class="po-op-action-row">
                      <button type="button" class="po-btn po-btn-sm is-danger" data-action="remove-downtime-item-drop" data-drop-id="{{id}}">Remove</button>
                    </div>
                  </div>
                  {{/each}}
                  {{else}}
                  <div class="po-op-summary">No direct item grants queued.</div>
                  {{/if}}
                </div>
              </label>
              <label class="po-resource-row po-notes-row-lg">
                <span>GM Notes (shown in result)</span>
                <textarea name="resolveDowntimeNotes" rows="3" class="po-input" placeholder="Narrative notes, contacts, or conditions">{{downtime.gmResolve.gmNotes}}</textarea>
              </label>
              {{#if downtime.gmResolve.selectedIsPreResolved}}
              <div class="po-op-summary is-good">{{downtime.gmResolve.selectedPreResolvedLabel}}</div>
              {{/if}}
              <div class="po-hint" data-downtime-resolve-hint>{{downtime.gmResolve.hint}}</div>
              <div class="po-op-action-row">
                <button type="button" class="po-btn po-btn-sm" data-action="prefill-downtime-resolution">Load Activity Base</button>
                <button type="button" class="po-btn po-btn-sm" data-action="pre-resolve-selected-downtime-entry">Pre-Resolve (Roll)</button>
                <button type="button" class="po-btn po-btn-sm" data-action="resolve-selected-downtime-entry">Final Resolve to Inbox</button>
              </div>
              {{else}}
              <div class="po-op-summary">No pending downtime entries to resolve.</div>
              {{/if}}
            </div>

            <div class="po-op-action-row">
              <button type="button" class="po-btn po-btn-sm is-danger" data-action="clear-downtime-results">Clear Resolved Logs</button>
            </div>
          </div>

          <div class="po-col">
            <div class="po-op-role-row">
              <div class="po-op-role-head">
                <div class="po-op-role-name">Submitted Entries</div>
                <div class="po-op-role-status">{{downtime.pendingCount}} pending</div>
              </div>
              <label class="po-resource-row">
                <span>Sort Entries</span>
                <select class="po-select" data-action="set-downtime-entry-sort">
                  {{#each downtime.entriesSortOptions}}
                  <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </label>

              {{#if downtime.hasEntries}}
              {{#each downtime.entries}}
              <div class="po-op-role-row">
                <div class="po-op-role-head">
                  <div class="po-op-role-name">{{actorName}}</div>
                  <div class="po-op-role-status {{#if pending}}is-warn{{else}}is-ready{{/if}}">{{statusLabel}}</div>
                </div>
                <div class="po-op-summary">{{actionLabel}} - {{hours}} hour(s)</div>
                {{#if hasNote}}<div class="po-op-summary">Note: {{note}}</div>{{/if}}
                <div class="po-op-summary">Updated: {{updatedAtLabel}} by {{updatedBy}}</div>
                {{#if hasPreResolved}}
                <div class="po-op-summary is-good">Pre-Resolved Draft: {{preResolvedAtLabel}} by {{preResolvedBy}}</div>
                {{/if}}
                {{#if hasResult}}
                <div class="po-op-summary">Result: {{resultSummary}}</div>
                <div class="po-op-summary">Roll {{rollTotal}} - GP +{{gpAward}} / -{{gpCost}} (Net {{gpDeltaLabel}}) - Progress {{progress}}</div>
                {{#if hasRumorCount}}<div class="po-op-summary">Rumors/Leads: {{rumorCount}}</div>{{/if}}
                {{#if hasItemRewards}}
                <div class="po-op-summary">Item Rewards:</div>
                {{#each itemRewards}}
                <div class="po-op-summary">{{this}}</div>
                {{/each}}
                {{/if}}
                {{#if hasItemRewardDrops}}
                <div class="po-op-summary">Crafted Item Grants:</div>
                {{#each itemRewardDrops}}
                <div class="po-op-summary">{{name}} x{{quantity}}</div>
                {{/each}}
                {{/if}}
                {{#if hasSocialContract}}<div class="po-op-summary">Connection: {{socialContractLabel}}</div>{{/if}}
                {{#if hasSocialContract}}<div class="po-op-summary">{{socialContractSummary}}</div>{{/if}}
                {{#if hasSocialContract}}<div class="po-op-summary">Limitations: {{socialContractLimitations}}</div>{{/if}}
                {{#if hasSocialContractNotes}}<div class="po-op-summary">Connection Notes: {{socialContractNotes}}</div>{{/if}}
                {{#if hasGmNotes}}<div class="po-op-summary">GM Notes: {{gmNotes}}</div>{{/if}}
                {{#if hasComplication}}<div class="po-op-summary is-warn">Complication: {{complication}}</div>{{/if}}
                {{#if hasClaimableRewards}}<div class="po-op-summary">Claimable: {{rewardSummary}}</div>{{/if}}
                {{#if hasResultDetails}}
                {{#each resultDetails}}
                <div class="po-op-summary">{{this}}</div>
                {{/each}}
                {{/if}}
                {{#if resolvedAtLabel}}<div class="po-op-summary">Resolved: {{resolvedAtLabel}} by {{resolvedBy}}</div>{{/if}}
                {{#if isCollected}}
                <div class="po-op-summary is-good">Collected: {{collectedAtLabel}} by {{collectedBy}}</div>
                {{else}}
                {{#if canCollect}}
                <button type="button" class="po-btn po-btn-sm" data-action="collect-downtime-result" data-actor-id="{{actorId}}">Collect Result</button>
                {{/if}}
                {{/if}}
                {{#unless pending}}
                <button type="button" class="po-btn po-btn-sm" data-action="edit-downtime-result" data-actor-id="{{actorId}}">Edit Result</button>
                {{/unless}}
                {{/if}}
                {{#if canClear}}
                <button type="button" class="po-btn po-btn-sm" data-action="clear-downtime-entry" data-actor-id="{{actorId}}">Clear Entry</button>
                {{/if}}
              </div>
              {{/each}}
              {{else}}
              <div class="po-op-summary">No downtime entries submitted yet.</div>
              {{/if}}
            </div>
          </div>
        </div>

        <details class="po-panel-disclosure" open>
          <summary class="po-panel-disclosure-summary">
            <span class="po-section-title">Resolved Logs</span>
            <span class="po-op-summary">Most recent outcomes</span>
          </summary>
          <div class="po-panel-disclosure-body">
            <label class="po-resource-row">
              <span>Sort Logs</span>
              <select class="po-select" data-action="set-downtime-log-sort">
                {{#each downtime.logsSortOptions}}
                <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                {{/each}}
              </select>
            </label>
            {{#if downtime.hasLogs}}
            {{#each downtime.logs}}
            <div class="po-op-role-row" data-log-id="{{logId}}">
              <div class="po-op-role-head">
                <div class="po-op-role-name">{{actorName}} - {{actionLabel}}</div>
                <div class="po-op-role-status">{{hours}} hour(s)</div>
              </div>
              <div class="po-op-summary">{{summary}}</div>
              {{#if hasDetails}}
              {{#each details}}
              <div class="po-op-summary">{{this}}</div>
              {{/each}}
              {{/if}}
              <div class="po-op-summary">GP +{{gpAward}} / -{{gpCost}} (Net {{gpDeltaLabel}})</div>
              {{#if hasRumorCount}}<div class="po-op-summary">Rumors/Leads: {{rumorCount}}</div>{{/if}}
              {{#if hasItemRewards}}<div class="po-op-summary">Item Rewards: {{#each itemRewards}}{{this}}{{#unless @last}}; {{/unless}}{{/each}}</div>{{/if}}
              {{#if hasItemRewardDrops}}<div class="po-op-summary">Crafted Item Grants: {{#each itemRewardDrops}}{{name}} x{{quantity}}{{#unless @last}}; {{/unless}}{{/each}}</div>{{/if}}
              {{#if hasSocialContract}}<div class="po-op-summary">Connection: {{socialContractLabel}}</div>{{/if}}
              {{#if hasSocialContract}}<div class="po-op-summary">{{socialContractSummary}}</div>{{/if}}
              {{#if hasSocialContract}}<div class="po-op-summary">Limitations: {{socialContractLimitations}}</div>{{/if}}
              {{#if hasSocialContractNotes}}<div class="po-op-summary">Connection Notes: {{socialContractNotes}}</div>{{/if}}
              {{#if hasGmNotes}}<div class="po-op-summary">GM Notes: {{gmNotes}}</div>{{/if}}
              {{#if hasComplication}}<div class="po-op-summary is-warn">Complication: {{complication}}</div>{{/if}}
              {{#if hasClaimableRewards}}<div class="po-op-summary">Claimable: {{rewardSummary}}</div>{{/if}}
              <div class="po-op-summary">Resolved: {{resolvedAtLabel}} by {{resolvedBy}}</div>
              {{#if isCollected}}
              <div class="po-op-summary is-good">Collected: {{collectedAtLabel}} by {{collectedBy}}</div>
              {{/if}}
              <div class="po-op-action-row">
                <button type="button" class="po-btn po-btn-sm" data-action="unarchive-downtime-log" data-log-id="{{logId}}">Unarchive for Edit</button>
                <button type="button" class="po-btn po-btn-sm" data-action="post-downtime-log" data-log-id="{{logId}}">Post Outcome</button>
                <button type="button" class="po-btn po-btn-sm is-danger" data-action="clear-downtime-log" data-log-id="{{logId}}">Clear Log</button>
              </div>
            </div>
            {{/each}}
            {{else}}
            <div class="po-op-summary">No downtime logs yet.</div>
            {{/if}}
          </div>
        </details>
      </div>
    </section>
  </div>
</div>
