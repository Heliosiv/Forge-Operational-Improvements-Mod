<div class="po-window po-window-marching" data-tool="marching-order" data-main-tab="marching-order" role="region" aria-label="Party Operations Marching Order">
  <header class="po-header">
    <div class="po-header-main">
      <h1 class="po-title">Party Operations</h1>
      <div class="po-subtitle" aria-live="polite">Marching Order - Last updated {{lastUpdatedAt}} by {{lastUpdatedBy}}</div>
    </div>
    <div class="po-context-pill" aria-hidden="true">Marching</div>
    <div class="po-controls">
      <button type="button" class="po-icon-btn" data-action="refresh" aria-label="Refresh">
        <i class="fa-solid fa-rotate"></i>
      </button>
      {{#if showPopout}}
      <button type="button" class="po-icon-btn" data-action="popout" aria-label="Pop out">
        <i class="fa-solid fa-up-right-from-square"></i>
      </button>
      {{/if}}
    </div>
  </header>

  {{#if lockBannerText}}
  <div class="po-lock-banner {{lockBannerClass}}" title="{{lockBannerTooltip}}">{{lockBannerText}}</div>
  {{/if}}

  <div class="po-body">

  <nav class="po-tabs po-tabs-main" role="navigation" aria-label="Party Operations views">
    <button type="button" class="po-tab" data-action="main-tab" data-tab="rest-watch" aria-current="false">Rest Watch</button>
    <button type="button" class="po-tab is-active" data-action="main-tab" data-tab="marching-order" aria-current="page">Marching Order</button>
    <button type="button" class="po-tab" data-action="main-tab" data-tab="operations" aria-current="false">Operations</button>
    {{#if isGM}}
    <button type="button" class="po-tab" data-action="main-tab" data-tab="gm" aria-current="false">GM</button>
    {{/if}}
  </nav>
  <section class="po-overview" aria-label="Marching status">
    <article class="po-overview-card">
      <span>Assigned Actors</span>
      <strong>{{overview.totalAssigned}}</strong>
    </article>
    <article class="po-overview-card">
      <span>Front / Middle / Rear</span>
      <strong>{{overview.frontCount}} / {{overview.middleCount}} / {{overview.rearCount}}</strong>
    </article>
    <article class="po-overview-card">
      <span>Formation</span>
      <strong>{{overview.formationLabel}}</strong>
    </article>
    <article class="po-overview-card">
      <span>Light Sources</span>
      <strong>{{overview.lightSources}}</strong>
    </article>
    <article class="po-overview-card">
      <span>Lock Status</span>
      <strong>{{overview.lockState}}</strong>
    </article>
  </section>

  <section class="po-content">
    <section class="po-usage-panel po-collapsible {{#if usageCollapsed}}is-collapsed{{/if}}" data-section-id="usage">
      <header class="po-collapsible-head">
        <div class="po-section-title">How to Use</div>
      </header>
      {{#unless usageCollapsed}}
      <div class="po-collapsible-body">
        <ul class="po-help-list">
          <li>Use <strong>Add Actor</strong> in each rank to assign party members.</li>
          <li>Drag actor cards by the grip handle to reorder within a rank.</li>
          <li>Edit each actor's <strong>Notes</strong> directly inside their card.</li>
          <li>Use <strong>Lock Marching Order</strong> to freeze player edits during planning.</li>
          <li>Use <strong>Share with Players</strong> after confirming the current formation.</li>
        </ul>
      </div>
      {{/unless}}
    </section>

    <div class="po-grid">
      <div class="po-ranks">
        {{#each ranks}}
        <section class="po-rank-col po-collapsible {{#if collapsed}}is-collapsed{{/if}}" data-rank-id="{{id}}" data-section-id="rank-{{id}}">
          <header class="po-rank-header">
            <div class="po-rank-info">
              <div class="po-rank-title-group">
                <i class="po-rank-icon fa-solid {{icon}}"></i>
                <div>
                  <div class="po-rank-title">{{label}}</div>
                  <div class="po-rank-desc">{{desc}}</div>
                </div>
              </div>
              {{#if capacity}}
              <div class="po-rank-capacity">
                <div class="po-rank-cap-text">{{entries.length}} / {{capacity}}</div>
                <div class="po-rank-cap-bar">
                  <div class="po-rank-cap-fill" style="width: {{capacityPercent}}%"></div>
                </div>
              </div>
              {{/if}}
            </div>
            {{#if ../isGM}}
            <button type="button" class="po-btn po-btn-sm" data-action="assign-rank" data-rank-id="{{id}}"><i class="fa-solid fa-user-plus"></i> Add Actor</button>
            {{/if}}
          </header>

          {{#unless collapsed}}
          <div class="po-rank-entries">
            {{#each entries}}
            <article class="po-entry {{#if ../isGM}}is-draggable{{/if}}" data-actor-id="{{actorId}}" {{#if ../isGM}}draggable="true"{{/if}}>
              {{#if ../../isGM}}
              <button type="button" class="po-entry-handle" aria-label="Drag">
                <i class="fa-solid fa-grip-lines"></i>
              </button>
              {{/if}}
              <img class="po-portrait" src="{{actor.img}}" alt="{{actor.name}}" />
              <div class="po-entry-main">
                <div class="po-entry-title">
                  {{actor.name}}
                  <button type="button" class="po-icon-btn" data-action="ping" aria-label="Ping token">
                    <i class="fa-solid fa-location-dot"></i>
                  </button>
                </div>
                <div class="po-entry-sub">
                  <span class="po-pill">PP {{actor.passivePerception}}</span>
                  {{#if ../../isGM}}
                  {{#if actor.ac}}
                  <span class="po-pill">AC {{actor.ac}}</span>
                  {{/if}}
                  {{#if actor.darkvision}}
                  <span class="po-pill">Darkvision {{actor.darkvision}}</span>
                  {{/if}}
                  {{#if actor.stealthDisadv}}
                  <span class="po-pill is-warn">Stealth Disadv</span>
                  {{/if}}
                  {{#if actor.languages}}
                  <span class="po-pill">Lang {{actor.languages}}</span>
                  {{/if}}
                  {{#if actor.passiveInsight}}
                  <span class="po-pill">PI {{actor.passiveInsight}}</span>
                  {{/if}}
                  {{#if actor.passiveInvestigation}}
                  <span class="po-pill">PIv {{actor.passiveInvestigation}}</span>
                  {{/if}}
                  {{/if}}
                  {{#if hasLight}}
                  <span class="po-pill po-pill-torch" title="{{lightTooltip}}">
                    <i class="fa-solid fa-fire" aria-hidden="true"></i>
                    Torch
                  </span>
                  {{/if}}
                </div>
                <div class="po-entry-notes" data-actor-id="{{actorId}}">
                  <div class="po-note-label">Notes</div>
                  <label class="po-sr-only" for="po-march-note-{{../id}}-{{actorId}}">Notes for {{actor.name}}</label>
                  <textarea id="po-march-note-{{../id}}-{{actorId}}" class="po-notes-input po-entry-notes-input" rows="2" placeholder="Notes" aria-label="Notes for {{actor.name}}" {{#unless canEditNote}}disabled{{/unless}}>{{notes}}</textarea>
                </div>
              </div>
              <div class="po-entry-actions-inline">
                {{#if ../../isGM}}
                <button type="button" class="po-icon-btn" data-action="remove-from-rank" data-actor-id="{{actorId}}" aria-label="Remove">
                  <i class="fa-solid fa-xmark"></i>
                </button>
                {{/if}}
              </div>
            </article>
            {{/each}}

            {{#unless entries}}
            <div class="po-rank-empty">
              <i class="fa-solid fa-inbox"></i>
              <span>Empty</span>
            </div>
            {{/unless}}
          </div>
          {{/unless}}
        </section>
        {{/each}}
      </div>

      {{#if isGM}}
      <aside class="po-gm-panel">
        <div class="po-gm-section po-collapsible {{#if gmSections.shareCollapsed}}is-collapsed{{/if}}" data-section-id="gm-share">
          <header class="po-collapsible-head">
            <div class="po-section-title">Share</div>
          </header>
          {{#unless gmSections.shareCollapsed}}
          <div class="po-collapsible-body">
            <button type="button" class="po-btn" data-action="open-for-players"><i class="fa-solid fa-share-from-square"></i> Share with Players</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.helpCollapsed}}is-collapsed{{/if}}" data-section-id="gm-help">
          <header class="po-collapsible-head">
            <div class="po-section-title">Help</div>
          </header>
          {{#unless gmSections.helpCollapsed}}
          <div class="po-collapsible-body">
            <button type="button" class="po-btn" data-action="help">Help</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.lockCollapsed}}is-collapsed{{/if}}" data-section-id="gm-lock">
          <header class="po-collapsible-head">
            <div class="po-section-title">Lock</div>
          </header>
          {{#unless gmSections.lockCollapsed}}
          <div class="po-collapsible-body">
            <label class="po-switch">
              <input type="checkbox" data-action="toggle-lock" {{#if locked}}checked{{/if}} />
              <span>Lock Marching Order</span>
            </label>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.formationsCollapsed}}is-collapsed{{/if}}" data-section-id="gm-formations">
          <header class="po-collapsible-head">
            <div class="po-section-title">Formations</div>
          </header>
          {{#unless gmSections.formationsCollapsed}}
          <div class="po-collapsible-body">
            <div class="po-formation-display">Current: <strong>{{formationLabel}}</strong></div>
            <div class="po-formation-effect">Surprise: {{doctrineEffects.surprise}}</div>
            <div class="po-formation-effect">Ambush: {{doctrineEffects.ambush}}</div>
            <div class="po-formation-effect">Last doctrine check: {{doctrineTracker.lastCheckAt}}</div>
            <button type="button" class="po-btn {{#if activateFormation.default}}is-active{{/if}}" data-action="formation-standard">Default Formation</button>
            <button type="button" class="po-btn {{#if activateFormation.combatReady}}is-active{{/if}}" data-action="formation-combat-ready">Combat-Ready Formation</button>
            <button type="button" class="po-btn {{#if activateFormation.tightCorridor}}is-active{{/if}}" data-action="formation-tight-corridor">Tight Corridor Formation</button>
            <button type="button" class="po-btn {{#if activateFormation.lowVisibility}}is-active{{/if}}" data-action="formation-low-visibility">Low-Visibility Formation</button>
            <button type="button" class="po-btn" data-action="doctrine-check">Post Doctrine Check Prompt</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.lightCollapsed}}is-collapsed{{/if}}" data-section-id="gm-light">
          <header class="po-collapsible-head">
            <div class="po-section-title">Torch / Light</div>
          </header>
          {{#unless gmSections.lightCollapsed}}
          <div class="po-collapsible-body">
            {{#each lightToggles}}
            <div class="po-checkbox-target" data-actor-id="{{actorId}}">
              <input id="po-light-target-{{actorId}}" type="checkbox" data-action="toggle-light" {{#if hasLight}}checked{{/if}} />
              <label class="po-checkbox-target-label" for="po-light-target-{{actorId}}">{{actorName}}</label>
              <label class="po-sr-only" for="po-light-bright-{{actorId}}">Bright light distance for {{actorName}}</label>
              <input id="po-light-bright-{{actorId}}" type="number" min="0" max="999" step="1" class="po-input po-light-range-input" data-action="set-light-range" data-range="bright" value="{{bright}}" {{#unless hasLight}}disabled{{/unless}} />
              <span class="po-light-range-label">Bright</span>
              <label class="po-sr-only" for="po-light-dim-{{actorId}}">Dim light distance for {{actorName}}</label>
              <input id="po-light-dim-{{actorId}}" type="number" min="0" max="999" step="1" class="po-input po-light-range-input" data-action="set-light-range" data-range="dim" value="{{dim}}" {{#unless hasLight}}disabled{{/unless}} />
              <span class="po-light-range-label">Dim</span>
            </div>
            {{/each}}
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.exportCollapsed}}is-collapsed{{/if}}" data-section-id="gm-export">
          <header class="po-collapsible-head">
            <div class="po-section-title">Export</div>
          </header>
          {{#unless gmSections.exportCollapsed}}
          <div class="po-collapsible-body">
            <button type="button" class="po-btn" data-action="copy-text"><i class="fa-solid fa-copy"></i> Copy Text</button>
            <button type="button" class="po-btn" data-action="copy-md"><i class="fa-brands fa-markdown"></i> Copy Markdown</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.snapshotCollapsed}}is-collapsed{{/if}}" data-section-id="gm-snapshot">
          <header class="po-collapsible-head">
            <div class="po-section-title">Snapshot</div>
          </header>
          {{#unless gmSections.snapshotCollapsed}}
          <div class="po-collapsible-body">
            <button type="button" class="po-btn" data-action="commit-plan"><i class="fa-solid fa-floppy-disk"></i> Save Snapshot</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.clearCollapsed}}is-collapsed{{/if}}" data-section-id="gm-clear">
          <header class="po-collapsible-head">
            <div class="po-section-title">Clear</div>
          </header>
          {{#unless gmSections.clearCollapsed}}
          <div class="po-collapsible-body">
            <button type="button" class="po-btn is-danger" data-action="clear-all"><i class="fa-solid fa-trash"></i> Clear Plan</button>
          </div>
          {{/unless}}
        </div>

        <div class="po-gm-section po-collapsible {{#if gmSections.gmNotesCollapsed}}is-collapsed{{/if}}" data-section-id="gm-notes">
          <header class="po-collapsible-head">
            <div class="po-section-title">GM Marching Notes</div>
          </header>
          {{#unless gmSections.gmNotesCollapsed}}
          <div class="po-collapsible-body">
            <label class="po-sr-only" for="po-gm-march-notes">Global marching notes</label>
            <textarea id="po-gm-march-notes" class="po-gm-notes" rows="4" placeholder="Global notes" aria-label="Global marching notes">{{gmNotes}}</textarea>
          </div>
          {{/unless}}
        </div>
      </aside>
      {{/if}}
    </div>
  </section>
  </div>

  <footer class="po-footer">
    <div class="po-footer-text">Marching Order</div>
    <div class="po-footer-text">Drag and drop to reorder ranks</div>
  </footer>
</div>


