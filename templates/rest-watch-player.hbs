<div class="po-window po-window-rest-player" data-tool="rest-watch-player" role="region" aria-label="Party Operations Rest Watch Player View">
  <header class="po-header">
    <div class="po-header-main">
      <h1 class="po-title">Party Operations <span class="po-pill">v{{moduleVersion}}</span></h1>
      <div class="po-subtitle" aria-live="polite">Rest Watch (Player) - Last updated {{lastUpdatedAt}} by {{lastUpdatedBy}}</div>
    </div>
    <div class="po-context-pill" aria-hidden="true">Player View</div>
    <div class="po-controls">
      <button type="button" class="po-icon-btn" data-action="refresh" aria-label="Refresh">
        <i class="fa-solid fa-rotate"></i>
      </button>
    </div>
  </header>

  <div class="po-body">
  <section class="po-overview" aria-label="Rest watch status">
    <article class="po-overview-card">
      <span>Slots Filled</span>
      <strong>{{overview.occupiedSlots}} / {{overview.totalSlots}}</strong>
    </article>
    <article class="po-overview-card">
      <span>Assigned Entries</span>
      <strong>{{overview.assignedEntries}}</strong>
    </article>
    <article class="po-overview-card {{#if overview.hasLowDarkvisionCoverage}}is-alert{{/if}}">
      <span>Low Darkvision Slots</span>
      <strong>{{overview.lowDarkvisionSlots}}</strong>
    </article>
  </section>

  <section class="po-content">
    <div class="po-hint">Tip: use <strong>Assign Me</strong> to quickly claim an empty watch slot, then add notes only for your actor.</div>
    <div class="po-op-divider"></div>
    <section class="po-loot-claims-panel" aria-label="Loot claims">
      <div class="po-section-title">Loot Claims</div>
      <div class="po-loot-claims-summary-grid">
        <div class="po-op-summary"><strong>Published:</strong> {{lootClaims.publishedAtLabel}} by {{lootClaims.publishedBy}}</div>
        <div class="po-op-summary"><strong>Pool:</strong> {{lootClaims.itemCount}} item(s)</div>
        <div class="po-op-summary"><strong>Currency:</strong> {{lootClaims.currencyRemaining.pp}} pp - {{lootClaims.currencyRemaining.gp}} gp - {{lootClaims.currencyRemaining.sp}} sp - {{lootClaims.currencyRemaining.cp}} cp</div>
      </div>
      {{#if lootClaims.selectedActorClaimedCurrency}}
      <div class="po-op-summary">Selected actor already claimed a currency share.</div>
      {{/if}}
      {{#if lootClaims.hasItems}}
      <label class="po-resource-row po-loot-claims-actor-row">
        <span>Claim As</span>
        <select name="lootClaimActorId" class="po-select" data-action="set-loot-claim-actor">
          {{#each lootClaims.actorOptions}}
          <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
          {{/each}}
        </select>
      </label>
      {{#each lootClaims.items}}
      <div class="po-op-role-row po-loot-claim-card">
        <div class="po-op-role-head">
          <div class="po-op-role-name">{{name}}</div>
          <div class="po-op-role-status">{{itemType}}</div>
        </div>
        <div class="po-loot-claim-tags">
          {{#if hasRarity}}<span class="po-pill">Rarity: {{rarity}}</span>{{/if}}
          <span class="po-pill">Source: {{sourceLabel}}</span>
          {{#if isMajorItem}}<span class="po-pill is-warn">Major Item</span>{{/if}}
          {{#if selectedActorVouched}}<span class="po-pill po-loot-vouch-state">You vouched</span>{{/if}}
        </div>
        <div class="po-loot-claim-vouched-row">
          <span class="po-loot-claim-vouched-label">Vouched By</span>
          {{#if hasVouchers}}
          <div class="po-loot-claim-vouch-list">
            {{#each vouchedByNames}}
            <span class="po-pill po-loot-vouch-chip">{{this}}</span>
            {{/each}}
          </div>
          {{else}}
          <span class="po-op-summary">No vouchers yet</span>
          {{/if}}
        </div>
        {{#if requiresRollOff}}<div class="po-op-summary is-warn">Contested major item: GM roll-off required.</div>{{/if}}
        <div class="po-op-action-row po-loot-claim-actions">
          <button type="button" class="po-btn po-btn-sm is-primary" data-action="claim-loot-item" data-item-id="{{id}}" {{#unless canClaimDirect}}disabled{{/unless}}>Claim</button>
          <button type="button" class="po-btn po-btn-sm" data-action="toggle-loot-vouch" data-item-id="{{id}}" data-should-vouch="{{#if selectedActorVouched}}false{{else}}true{{/if}}" {{#unless canVouch}}disabled{{/unless}}>{{#if selectedActorVouched}}Unvouch{{else}}Vouch{{/if}}</button>
          {{#if canOpen}}
          <button type="button" class="po-btn po-btn-sm" data-action="open-loot-item" data-uuid="{{uuid}}">Open</button>
          {{/if}}
        </div>
      </div>
      {{/each}}
      {{else}}
      <div class="po-op-summary">No claimable items are currently published.</div>
      {{/if}}
      <div class="po-op-action-row">
        <button type="button" class="po-btn po-btn-sm is-primary" data-action="claim-loot-currency" {{#unless lootClaims.canClaimCurrency}}disabled{{/unless}}>Claim Currency Share</button>
      </div>
    </section>
    <div class="po-op-divider"></div>
    <div class="po-cards">
      {{#each slots}}
      <article class="po-card" data-slot-id="{{id}}">
        <div class="po-card-left">
          <div class="po-slot-badge">{{label}}</div>
          {{#if timeRange}}
          <div class="po-time-range">{{timeRange}}</div>
          {{/if}}
        </div>

        <div class="po-card-center">
          {{#if hasEntries}}
          {{#each entries}}
          <div class="po-watch-entry" data-actor-id="{{actorId}}">
            <div class="po-actor">
              <img class="po-portrait" src="{{actor.img}}" alt="{{actor.name}}" />
              <div class="po-actor-meta">
                <div class="po-actor-name">
                  {{actor.name}}
                  <button type="button" class="po-icon-btn" data-action="ping" aria-label="Ping token">
                    <i class="fa-solid fa-location-dot"></i>
                  </button>
                </div>
                <div class="po-watch-stats">
                  {{#if actor.passivePerception}}
                  <div class="po-stat po-stat-primary">
                    <span class="po-stat-label">PP</span>
                    <span class="po-stat-value">{{actor.passivePerception}}</span>
                  </div>
                  {{/if}}
                </div>
              </div>
            </div>

            {{#if activity}}
            <div class="po-activity-section">
              <div class="po-activity-row is-compact">
                <div class="po-exhaustion-badge {{#if activity.exhaustion}}is-exhausted{{/if}}" title="Exhaustion: {{activity.exhaustionLabel}}">
                  {{#if activity.exhaustion}}
                  <i class="fa-solid fa-heart-crack"></i>
                  <span>{{activity.exhaustion}}</span>
                  {{else}}
                  <i class="fa-solid fa-heart"></i>
                  {{/if}}
                </div>
              </div>
            </div>
            {{/if}}

            <div class="po-entry-actions">
              <button type="button" class="po-icon-btn" data-action="toggle-notes" aria-controls="po-player-notes-{{../id}}-{{actorId}}" aria-expanded="{{#if notes}}true{{else}}false{{/if}}" aria-label="Toggle notes for {{actor.name}}">
                <i class="fa-solid fa-note-sticky"></i>
              </button>
              {{#if canClear}}
              <button type="button" class="po-icon-btn" data-action="clear" aria-label="Clear">
                <i class="fa-solid fa-xmark"></i>
              </button>
              {{/if}}
            </div>

            <div id="po-player-notes-{{../id}}-{{actorId}}" class="po-notes {{#if notes}}is-active{{/if}}" aria-hidden="{{#if notes}}false{{else}}true{{/if}}">
              <label class="po-sr-only" for="po-player-note-input-{{../id}}-{{actorId}}">Notes for {{actor.name}}</label>
              <textarea id="po-player-note-input-{{../id}}-{{actorId}}" class="po-notes-input" rows="2" placeholder="Notes" aria-label="Notes for {{actor.name}}" {{#unless canEditNotes}}disabled{{/unless}}>{{notes}}</textarea>
            </div>
          </div>
          {{/each}}
          {{/if}}

          {{#unless hasEntries}}
          <div class="po-empty">
            <div class="po-empty-text">Assign character(s)...</div>
          </div>
          {{/unless}}

          <div class="po-assign-actions">
            {{#if canAssignMe}}
            <button type="button" class="po-btn is-primary" data-action="assign-me">+ Assign Me</button>
            {{/if}}
          </div>
        </div>
      </article>
      {{/each}}
    </div>
  </section>
  </div>

  <footer class="po-footer">
    <div class="po-footer-text">Rest Watch</div>
    <div class="po-footer-text">Player view</div>
  </footer>
</div>


